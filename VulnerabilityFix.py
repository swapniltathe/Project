# Vulnerability - World writable files perm revoke for Unix
import os
import stat
# Find world writable files and directory on unix:
# Linux: df --local -P | awk {'if (NR!=1) print $6'} | xargs -I '<>' find '<>' -xdev -type f -perm -0002 -exec ls -ltr {} \; #files
#        df --local -P | awk {'if (NR!=1) print $6'} | xargs -I '<>' find '<>' -xdev -type d -perm -0002 -exec ls -ld {} \; #directory
# AIX:   df -P | grep -v : | awk {'if (NR!=1) print $6'} | xargs -I '<>' find '<>' -xdev -type f -perm -0002 -exec ls -ltr {} \; #files
#        df -P | grep -v : | awk {'if (NR!=1) print $6'} | xargs -I '<>' find '<>' -xdev -type d -perm -0002 -exec ls -ld {} \; #directory
# check if file exists
    # if exists then note down permissions
        # change permissions
        # print permissions changed for file
# if file don't exists
    # print file not found
outfile = lambda x: out_file.write(x + "\n")

try:
    check_file = open("/tmp/test/ww_files", "r")
    out_file = open("/tmp/test/output.csv", "a")
    print("File Name,Status,Before,Current")
    # out_file.write("File Name,Status,Before,Current")
    outfile("File Name,Status,Before,Current")
    for file in check_file.readlines():
        file = file.strip()
        if os.path.exists(file):
            curr_perm = stat.S_IMODE(os.stat(file).st_mode)
            if stat.filemode(curr_perm)[-2] == 'w':
                # print(file + ", found")
                old_out = os.popen("ls -ltr " + file).read().strip()
                # print(old_out)
                # os.system("chmod"+" o-w "+file)
                os.chmod(file, curr_perm-2)
                new_out = os.popen("ls -ltr " + file).read().strip()
                # print(type(new_out))
                print(file + ",Fixed," + old_out + "," + new_out)
                # out_file.write(file + ",Fixed," + old_out + "," + new_out + "\n")
                outfile(file + ",Fixed," + old_out + "," + new_out)
            else:
                curr_out = os.popen("ls -ltr " + file).read().strip()
                print(file + ",Not World Writable,," + curr_out)
                # out_file.write(file + ",Not World Writable,," + curr_out + "\n")
                outfile(file + ",Not World Writable,," + curr_out)
        else:
            print(file + ",Not found")
            # out_file.write(file + ",Not found\n")
            outfile(file + ",Not found")

except Exception as e:
    print("Error: ", e)

finally:
    check_file.close()
    out_file.close()
